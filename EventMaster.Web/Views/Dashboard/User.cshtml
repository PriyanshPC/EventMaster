@model EventMaster.Web.Models.CustomerDashboardViewModel
@{
    ViewData["Title"] = "Customer Dashboard";
    var bookingsActive = Model.ActiveTab != "settings";
    var settingsActive = Model.ActiveTab == "settings";

    string StatusBadgeClass(string status)
    {
        return status?.Trim().ToLowerInvariant() switch
        {
            "confirmed" => "text-bg-success",
            "cancelled" => "text-bg-danger",
            "completed" => "text-bg-secondary",
            _ => "text-bg-light text-dark"
        };
    }
}

<div class="container my-4">
    <h1 class="h4 fw-bold mb-3">Customer Dashboard</h1>

    <ul class="nav nav-tabs mb-4" id="customerDashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(bookingsActive ? "active" : "")"
                    id="bookings-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#bookings-pane"
                    type="button"
                    role="tab"
                    aria-controls="bookings-pane"
                    aria-selected="@(bookingsActive ? "true" : "false")">
                Bookings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(settingsActive ? "active" : "")"
                    id="settings-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#settings-pane"
                    type="button"
                    role="tab"
                    aria-controls="settings-pane"
                    aria-selected="@(settingsActive ? "true" : "false")">
                Settings
            </button>
        </li>
    </ul>

    <div class="tab-content" id="customerDashboardTabContent">
        <div class="tab-pane fade @(bookingsActive ? "show active" : "")" id="bookings-pane" role="tabpanel" aria-labelledby="bookings-tab" tabindex="0">
            <h2 class="h5">Upcoming</h2>
            <div class="row g-3 mb-4">
                @if (Model.UpcomingBookings.Count == 0)
                {
                    <div class="alert alert-info mb-0" role="alert">No upcoming bookings.</div>
                }
                @foreach (var e in Model.UpcomingBookings)
                {
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3 d-flex justify-content-center">
                        <a class="em-card em-card-sm d-block h-100 w-100" asp-action="BookingDetails" asp-route-bookingId="@e.BookingId">
                            <div class="em-card-img"><img src="@e.ImageUrl" alt="@e.Name" /></div>
                            <div class="em-card-body">
                                <div class="em-card-eyebrow">@e.Category.ToUpper()</div>
                                <div class="em-card-title">@e.Name</div>
                                <div class="em-card-sub">@e.SubTitle</div>
                                <div class="em-card-sub">@e.VenueLine</div>
                                <div class="mt-2">
                                    <span class="badge fw-bold @StatusBadgeClass(e.Status)">@e.Status</span>
                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <h2 class="h5">Past</h2>
            <div class="row g-3">
                @if (Model.PastBookings.Count == 0)
                {
                    <div class="alert alert-secondary mb-0" role="alert">No past bookings.</div>
                }
                @foreach (var e in Model.PastBookings)
                {
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3 d-flex justify-content-center">
                        <a class="em-card em-card-sm d-block h-100 w-100" asp-action="BookingDetails" asp-route-bookingId="@e.BookingId">
                            <div class="em-card-img"><img src="@e.ImageUrl" alt="@e.Name" /></div>
                            <div class="em-card-body">
                                <div class="em-card-eyebrow">@e.Category.ToUpper()</div>
                                <div class="em-card-title">@e.Name</div>
                                <div class="em-card-sub">@e.SubTitle</div>
                                <div class="em-card-sub">@e.VenueLine</div>
                                <div class="mt-2">
                                    <span class="badge fw-bold @StatusBadgeClass(e.Status)">@e.Status</span>
                                </div>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </div>

        <div class="tab-pane fade @(settingsActive ? "show active" : "")" id="settings-pane" role="tabpanel" aria-labelledby="settings-tab" tabindex="0">
            <div class="card p-3">
                <div class="mb-2"><strong>Name:</strong> @Model.Settings.Name</div>
                <div class="mb-3"><strong>Username:</strong> @Model.Settings.Username</div>

                <form asp-action="UpdateProfile" method="post" class="row g-3">
                    @Html.AntiForgeryToken()

                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <div class="input-group">
                            <input id="email" class="form-control" name="email" value="@Model.Settings.Email" readonly required />
                            <button class="btn btn-outline-primary" type="button" data-edit-target="email" title="Edit email">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="phone" class="form-label">Phone</label>
                        <div class="input-group">
                            <input id="phone" class="form-control" name="phone" value="@Model.Settings.Phone" readonly />
                            <button class="btn btn-outline-primary" type="button" data-edit-target="phone" title="Edit phone">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input id="currentPassword" class="form-control" type="password" name="currentPassword" placeholder="Required for any changes" required />
                    </div>
                    <div class="col-md-4">
                        <label for="newPassword" class="form-label">New Password (optional)</label>
                        <input id="newPassword" class="form-control" type="password" name="newPassword" placeholder="Leave blank to keep" />
                    </div>
                    <div class="col-md-4">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input id="confirmPassword" class="form-control" type="password" name="confirmPassword" placeholder="If changing password" />
                    </div>

                    <div class="col-12">
                        <button class="btn btn-success" type="submit">Update Profile</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('[data-edit-target]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = document.getElementById(btn.dataset.editTarget);
                if (!target) return;

                target.readOnly = !target.readOnly;
                if (!target.readOnly) {
                    target.focus();
                    target.select?.();
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                }
            });
        });
    </script>
}
