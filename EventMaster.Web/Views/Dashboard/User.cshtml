@model EventMaster.Web.Models.Dashboard.UserDashboardVm
@{
    ViewData["Title"] = "User Dashboard";
}

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h2 class="mb-1">Dashboard</h2>
            <div class="text-muted">
                @Model.Me.Name (@Model.Me.Username)
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="alert alert-danger mb-0">@Model.Error</div>
        }
        else if (TempData["ToastError"] != null)
        {
            <div class="alert alert-danger mb-0">@TempData["ToastError"]</div>
        }
        else if (TempData["Toast"] != null)
        {
            <div class="alert alert-success mb-0">@TempData["Toast"]</div>
        }
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="dashTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings"
                    type="button" role="tab" aria-controls="bookings" aria-selected="true">
                Bookings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings"
                    type="button" role="tab" aria-controls="settings" aria-selected="false">
                Settings
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- BOOKINGS TAB -->
        <div class="tab-pane fade show active" id="bookings" role="tabpanel" aria-labelledby="bookings-tab">

            <h4 class="mt-2">Upcoming</h4>
            @if (Model.Upcoming.Count == 0)
            {
                <div class="text-muted mb-4">No upcoming bookings.</div>
            }
            else
            {
                <div class="row g-3 mb-4">
                    @foreach (var b in Model.Upcoming)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <a class="text-decoration-none" href="@Url.Action("BookingDetails", "Dashboard", new { id = b.BookingId })">
                                <div class="card h-100 shadow-sm">
                                    @if (!string.IsNullOrWhiteSpace(b.Image))
                                    {
                                        <img src="@b.Image" class="card-img-top" alt="@b.Name" style="object-fit: cover; height: 180px;" />
                                    }
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h5 class="card-title mb-1">@b.Name</h5>
                                            <span class="badge bg-secondary">@b.Status</span>
                                        </div>
                                        <div class="text-muted small mb-2">@b.Category</div>
                                        <div class="small">
                                            <div><strong>Date:</strong> @b.StartDateTimeUtc.ToLocalTime().ToString("MMM dd, yyyy")</div>
                                            <div><strong>Time:</strong> @b.StartDateTimeUtc.ToLocalTime().ToString("h:mm tt")</div>
                                            <div><strong>Venue:</strong> @b.VenueName, @b.VenueCity</div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-white small text-muted">
                                        Booking #@b.BookingId • Occ #@b.OccurrenceId
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }

            <h4>Past</h4>
            @if (Model.Past.Count == 0)
            {
                <div class="text-muted">No past bookings.</div>
            }
            else
            {
                <div class="row g-3">
                    @foreach (var b in Model.Past)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <a class="text-decoration-none" href="@Url.Action("BookingDetails", "Dashboard", new { id = b.BookingId })">
                                <div class="card h-100 shadow-sm">
                                    @if (!string.IsNullOrWhiteSpace(b.Image))
                                    {
                                        <img src="@b.Image" class="card-img-top" alt="@b.Name" style="object-fit: cover; height: 180px;" />
                                    }
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h5 class="card-title mb-1">@b.Name</h5>
                                            <span class="badge bg-secondary">@b.Status</span>
                                        </div>
                                        <div class="text-muted small mb-2">@b.Category</div>
                                        <div class="small">
                                            <div><strong>Date:</strong> @b.StartDateTimeUtc.ToLocalTime().ToString("MMM dd, yyyy")</div>
                                            <div><strong>Time:</strong> @b.StartDateTimeUtc.ToLocalTime().ToString("h:mm tt")</div>
                                            <div><strong>Venue:</strong> @b.VenueName, @b.VenueCity</div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-white small text-muted">
                                        Booking #@b.BookingId • Occ #@b.OccurrenceId
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">

            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title mb-3">Account Details</h4>

                    <form method="post" asp-action="SaveSettings" asp-controller="Dashboard">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="modeInput" name="mode" value="none" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <div class="form-control-plaintext">@Model.Me.Name</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <div class="form-control-plaintext">@Model.Me.Username</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <div class="input-group">
                                <input id="emailInput" name="email" class="form-control" value="@Model.Me.Email" readonly />
                                <button id="editEmailBtn" class="btn btn-outline-primary" type="button">Edit</button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <div class="input-group">
                                <input id="phoneInput" name="phone" class="form-control" value="@Model.Me.Phone" readonly />
                                <button id="editPhoneBtn" class="btn btn-outline-primary" type="button">Edit</button>
                            </div>
                        </div>

                        <div class="col-12">
                            <hr />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Current Password</label>
                            <input id="currentPwd" name="currentPwd" type="password" class="form-control" placeholder="Required to confirm changes" />
                        </div>

                        <div class="col-md-6"></div>

                        <div class="col-md-6">
                            <label class="form-label">New Password</label>
                            <input id="newPwd" name="newPwd" type="password" class="form-control" disabled />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Confirm Password</label>
                            <input id="confirmPwd" name="confirmPwd" type="password" class="form-control" disabled />
                        </div>

                        <div class="col-12 d-flex gap-2 mt-2">
                            <button id="startPwdEditBtn" type="button" class="btn btn-outline-secondary">
                                Change Password
                            </button>

                            <!-- You will wire these to your existing profile/password endpoints
                                 using your existing JS/AJAX pattern -->
                            <button id="saveBtn" type="submit" class="btn btn-primary" disabled>
                                Save
                            </button>

                            <button id="cancelEditBtn" type="button" class="btn btn-outline-danger" disabled>
                                Cancel
                            </button>
                        </div>

                        <div class="col-12">
                            <div id="settingsMsg" class="small"></div>
                        </div>
                    </div>
                    </form>
                </div>
            </div>

            <script>
                // UI state machine: edit one parameter at a time
                const emailInput = document.getElementById("emailInput");
                const phoneInput = document.getElementById("phoneInput");
                const editEmailBtn = document.getElementById("editEmailBtn");
                const editPhoneBtn = document.getElementById("editPhoneBtn");
                const startPwdEditBtn = document.getElementById("startPwdEditBtn");

                const currentPwd = document.getElementById("currentPwd");
                const newPwd = document.getElementById("newPwd");
                const confirmPwd = document.getElementById("confirmPwd");

                const saveBtn = document.getElementById("saveBtn");
                const cancelEditBtn = document.getElementById("cancelEditBtn");

                const modeInput = document.getElementById("modeInput");
                let mode = "none"; // none | email | phone | password
                const originalEmail = emailInput.value;
                const originalPhone = phoneInput.value;

                function setMode(newMode) {
                    mode = newMode;
                    modeInput.value = newMode;

                    // default lock everything
                    emailInput.readOnly = true;
                    phoneInput.readOnly = true;

                    editEmailBtn.disabled = false;
                    editPhoneBtn.disabled = false;

                    newPwd.disabled = true;
                    confirmPwd.disabled = true;

                    startPwdEditBtn.disabled = false;

                    saveBtn.disabled = (mode === "none");
                    cancelEditBtn.disabled = (mode === "none");

                    if (mode === "email") {
                        emailInput.readOnly = false;
                        editPhoneBtn.disabled = true;
                        startPwdEditBtn.disabled = true;
                    }

                    if (mode === "phone") {
                        phoneInput.readOnly = false;
                        editEmailBtn.disabled = true;
                        startPwdEditBtn.disabled = true;
                    }

                    if (mode === "password") {
                        editEmailBtn.disabled = true;
                        editPhoneBtn.disabled = true;
                        newPwd.disabled = false;
                        confirmPwd.disabled = false;
                    }
                }

                editEmailBtn.addEventListener("click", () => setMode("email"));
                editPhoneBtn.addEventListener("click", () => setMode("phone"));
                startPwdEditBtn.addEventListener("click", () => setMode("password"));

                cancelEditBtn.addEventListener("click", () => {
                    emailInput.value = originalEmail;
                    phoneInput.value = originalPhone;
                    currentPwd.value = "";
                    newPwd.value = "";
                    confirmPwd.value = "";
                    setMode("none");
                });

                setMode("none");
            </script>

        </div>
    </div>
</div>